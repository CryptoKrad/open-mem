; C-Mem Worker Sandbox Profile (PRC-02)
; Applied via: sandbox-exec -f security/worker.sb -DHOME=$HOME -DCMEM_DIR=$(pwd) bun src/worker/server.ts
;
; Security model:
;   - Deny everything by default
;   - Allow broad file reads (runtime needs; restricting reads causes SIGABRT on macOS)
;   - Restrict file WRITES to only C-Mem data dir + /tmp
;   - Network: localhost IPC + HTTPS (Anthropic API) + DNS only

(version 1)
(deny default)

; ── Process basics ────────────────────────────────────────────────────────────
(allow process-fork)
(allow process-exec)
(allow signal (target self))

; ── Mach (macOS IPC — needed for Bun/Node runtime) ───────────────────────────
(allow mach-lookup)
(allow mach-register)

; ── System calls needed by Node/Bun ─────────────────────────────────────────
(allow sysctl-read)
(allow iokit-open)

; ── File reads: broad allow (restricting reads causes SIGABRT at process init) ──
; The key security control here is restricting WRITES, not reads.
(allow file-read*)

; ── File writes: only C-Mem data dir + temp ──────────────────────────────────
(allow file-write*
  (subpath (string-append (param "HOME") "/.c-mem"))
  (subpath "/private/tmp")
  (literal "/dev/stderr")
  (literal "/dev/stdout")
  (literal "/dev/null")
)

; ── Network: localhost IPC + Anthropic API (HTTPS) + DNS ─────────────────────
(allow network-outbound
  (remote ip "localhost:*")
  (remote tcp "*:443")
  (remote udp "*:53")
)
(allow network-inbound
  (local ip "localhost:*")
)
